/* =========================================================================
   Social Housing Definitions Explorer (MVP)
   - Reads CSV (Country, TermsUsed, Definition)
   - Search, Tag filters, Country select
   - Expand/collapse cards
   - Compare up to 3 countries with copy summary
   No third-party libs required.
   ======================================================================= */

/** ğŸ‘‰ CSV è·¯å¾‘å·²æ”¹ç‚ºä½ æä¾›çš„å›ºå®š commit raw é€£çµ */
const CSV_URL = "https://raw.githubusercontent.com/PN0929/globalhousingdata/3c9bdf0d7ad4bd2cc65b670a45ddc99ffc0d3de9/data/social_housing_definitions_clean_utf8.csv";

/** å¿«é€Ÿæ¨™ç±¤çš„åµæ¸¬é—œéµå­—ï¼ˆå¾ˆ MVP çš„è¦å‰‡å³å¯ï¼‰ */
const TAG_RULES = [
  { key: "HasPublicProvider",    label: "å…¬éƒ¨é–€æä¾›",     regex: /(public|municipal|state[-\s]?owned|government|local authority|authorities)/i },
  { key: "HasNonProfitProvider", label: "éç‡Ÿåˆ©/åˆä½œç¤¾",   regex: /(non[-\s]?profit|co-?operative|cooperative)/i },
  { key: "HasBelowMarketRent",   label: "ä½æ–¼å¸‚åƒ¹/ç§Ÿæ§",    regex: /(below market|rent cap|capped rent|regulated rent|moderate rent)/i },
  { key: "HasIncomeTargeting",   label: "æ”¶å…¥å¯©æŸ¥/ç›®æ¨™æ—ç¾¤", regex: /(income limit|low[-\s]?income|vulnerable|eligible|means[-\s]?test)/i },
  { key: "HasSubsidyOrLoans",    label: "è£œè²¼/è²¸æ¬¾/ç¨…å„ªæƒ ",  regex: /(subsid(y|ies)|grant(s)?|loan(s)?|tax|preferential rate)/i },
  { key: "LegalDefined",         label: "æ³•å¾‹å®šç¾©",         regex: /(law|act|defined in law|regulation|legal)/i },
];

/* ======================  Utility  ====================== */
const $ = (q, el = document) => el.querySelector(q);
const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));

function csvParse(text) {
  // Simple CSV parser (handles commas inside quotes)
  const rows = [];
  let cur = [], cell = "", inQ = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i+1];
    if (inQ) {
      if (c === '"' && n === '"') { cell += '"'; i++; }
      else if (c === '"') { inQ = false; }
      else { cell += c; }
    } else {
      if (c === '"') inQ = true;
      else if (c === "," ) { cur.push(cell); cell=""; }
      else if (c === "\n") { cur.push(cell); rows.push(cur); cur=[]; cell=""; }
      else if (c === "\r") { /* ignore */ }
      else { cell += c; }
    }
  }
  if (cell || cur.length) { cur.push(cell); rows.push(cur); }
  return rows;
}

function shortText(s, n=180) {
  if (!s) return "";
  const clean = s.replace(/\s+/g, " ").trim();
  if (clean.length <= n) return clean;
  const cut = clean.slice(0, n);
  const lastDot = Math.max(cut.lastIndexOf("."), cut.lastIndexOf("ã€‚"));
  return (lastDot > 60 ? cut.slice(0, lastDot+1) : cut + "â€¦");
}

/* ======================  State  ====================== */
const State = {
  data: [],          // {Country, TermsUsed, Definition, flags{}, short}
  filtered: [],
  selectedTags: new Set(),  // TAG_RULES.key
  selectedCountry: "ALL",
  searchText: "",
  compareSet: new Set(),    // country names
};

/* ======================  Bootstrap  ====================== */
document.addEventListener("DOMContentLoaded", async () => {
  ensureExplorerShell();      // create Explorer DOM
  await loadCSV();            // fetch & parse data
  buildControls();            // search + select + tags
  renderAll();                // cards + drawer
});

/* ======================  Shell DOM  ====================== */
function ensureExplorerShell() {
  const main = document.querySelector(".main-content") || document.body;
  // æ¸…ç©ºèˆŠæœ‰å…§å®¹çš„å¯è¦–å€åŸŸï¼ˆä¿ç•™ header/footerï¼‰
  const oldWelcome = $("#welcomeScreen"); if (oldWelcome) oldWelcome.remove();
  const oldViz = $("#visualizationArea"); if (oldViz) oldViz.remove();

  // Explorer container
  const wrap = document.createElement("section");
  wrap.id = "definitionsExplorer";
  wrap.innerHTML = `
    <div class="controls fade-in">
      <div class="searchbox">
        <input id="searchInput" type="text" placeholder="æœå°‹åœ‹å®¶ã€ç¨±å‘¼æˆ–å®šç¾©é—œéµå­—â€¦" />
      </div>
      <div class="selectbox">
        <select id="countrySelect"></select>
      </div>
      <div class="tags" id="tagBar">
        <!-- dynamic tag chips -->
      </div>
    </div>

    <div id="cardsWrap" class="cards fade-in"></div>

    <div id="emptyState" class="empty" style="display:none;">
      æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„çµæœï¼Œæ›å€‹é—œéµå­—æˆ–å–æ¶ˆä¸€äº›æ¨™ç±¤çœ‹çœ‹ï½
    </div>

    <aside id="compareDrawer" class="compare-drawer">
      <div class="compare-title">æ¯”è¼ƒï¼ˆæœ€å¤š 3 åœ‹ï¼‰</div>
      <div id="compareList"></div>
      <div class="compare-actions">
        <button class="btn" id="btnClearCompare">æ¸…ç©º</button>
        <button class="btn primary" id="btnCopyCompare">è¤‡è£½æ‘˜è¦</button>
      </div>
    </aside>
  `;
  main.prepend(wrap);
}

/* ======================  Load CSV  ====================== */
async function loadCSV() {
  try {
    const resp = await fetch(CSV_URL, { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();
    const rows = csvParse(text);
    if (!rows.length) throw new Error("CSV ç©ºç™½");
    const headers = rows[0].map(h => h.trim());
    const idxCountry = headers.findIndex(h => /country/i.test(h));
    const idxTerms   = headers.findIndex(h => /terms?used/i.test(h));
    const idxDef     = headers.findIndex(h => /definition/i.test(h));
    if (idxCountry < 0 || idxDef < 0) throw new Error("ç¼ºå°‘å¿…è¦æ¬„ä½ (Country/Definition)");

    const data = rows.slice(1).map(r => {
      const country = (r[idxCountry] || "").trim();
      const terms   = (idxTerms >= 0 ? r[idxTerms] : "" ) || "";
      const def     = (r[idxDef] || "").trim();
      const flags = {};
      const textForMatch = `${terms}\n${def}`;
      TAG_RULES.forEach(rule => flags[rule.key] = rule.regex.test(textForMatch));
      return {
        Country: country,
        TermsUsed: terms,
        Definition: def,
        short: shortText(def, 200),
        flags
      };
    }).filter(d => d.Country && d.Definition);

    State.data = data;
    State.filtered = data.slice();
  } catch (err) {
    const cards = $("#cardsWrap");
    cards.innerHTML = `
      <div class="empty">
        ç„¡æ³•è®€å– CSVï¼ˆ${err.message}ï¼‰ã€‚<br/>
        è«‹ç¢ºèªæª”æ¡ˆæ”¾åœ¨ <code>${CSV_URL}</code>ï¼Œæˆ–åœ¨ <code>app.js</code> ä¸Šæ–¹æ”¹è·¯å¾‘ã€‚
      </div>
    `;
  }
}

/* ======================  Controls  ====================== */
function buildControls() {
  // Country select
  const uniqueCountries = Array.from(new Set(State.data.map(d => d.Country))).sort((a,b)=>a.localeCompare(b));
  const sel = $("#countrySelect");
  sel.innerHTML = `<option value="ALL">å…¨éƒ¨åœ‹å®¶</option>` + uniqueCountries.map(c => `<option>${escapeHTML(c)}</option>`).join("");
  sel.addEventListener("change", e => {
    State.selectedCountry = e.target.value;
    applyFilters();
  });

  // Search
  $("#searchInput").addEventListener("input", e => {
    State.searchText = e.target.value.trim();
    applyFilters();
  });

  // Tag bar
  const tagBar = $("#tagBar");
  tagBar.innerHTML = TAG_RULES.map(t =>
    `<button class="tag" data-key="${t.key}">${t.label}</button>`
  ).join("");
  tagBar.addEventListener("click", e => {
    const btn = e.target.closest(".tag");
    if (!btn) return;
    const key = btn.dataset.key;
    if (State.selectedTags.has(key)) State.selectedTags.delete(key);
    else State.selectedTags.add(key);
    btn.classList.toggle("active");
    applyFilters();
  });

  // Compare actions
  $("#btnClearCompare").addEventListener("click", () => {
    State.compareSet.clear();
    renderCompare();
    // uncheck checkboxes
    $$(".card input[type='checkbox']").forEach(cb => cb.checked = false);
  });
  $("#btnCopyCompare").addEventListener("click", copyCompare);
}

/* ======================  Filtering  ====================== */
function applyFilters() {
  const q = State.searchText.toLowerCase();
  State.filtered = State.data.filter(d => {
    // country filter
    if (State.selectedCountry !== "ALL" && d.Country !== State.selectedCountry) return false;

    // tag filters: every selected tag must be true
    for (const key of State.selectedTags) if (!d.flags[key]) return false;

    // text search on country + terms + definition
    if (q) {
      const hay = (d.Country + " " + d.TermsUsed + " " + d.Definition).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });
  renderCards();
}

/* ======================  Render Cards  ====================== */
function renderAll() {
  renderCards();
  renderCompare();
}

function renderCards() {
  const wrap = $("#cardsWrap");
  const empty = $("#emptyState");
  if (!State.filtered.length) {
    wrap.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  wrap.innerHTML = State.filtered.map((d, idx) => cardHTML(d, idx)).join("");
  wrap.addEventListener("click", onCardClick, { once: true }); // delegate once to avoid multiple bindings
}

function cardHTML(d, idx) {
  const chips = TAG_RULES
    .filter(t => d.flags[t.key])
    .slice(0, 3)  // show up to 3 chips
    .map(t => `<span class="chip">${t.label}</span>`)
    .join("");

  const checked = State.compareSet.has(d.Country) ? "checked" : "";
  const safeCountry = escapeHTML(d.Country);
  const safeTerms   = escapeHTML(d.TermsUsed || "â€”");
  const safeShort   = escapeHTML(d.short);
  const safeFull    = escapeHTML(d.Definition);

  return `
    <article class="card" data-idx="${idx}">
      <div class="card-header">
        <div>
          <div class="country">${safeCountry}</div>
          <div class="terms">${safeTerms}</div>
        </div>
        <label class="mini">
          <input type="checkbox" class="cmp" data-country="${safeCountry}" ${checked} />
          åŠ å…¥æ¯”è¼ƒ
        </label>
      </div>
      <div class="summary">${safeShort}</div>
      <div class="actions">
        <button class="btn toggle">å±•é–‹å…¨æ–‡</button>
        <div class="chips">${chips}</div>
      </div>
      <div class="fulltext" style="display:none;">${safeFull}</div>
    </article>
  `;
}

function onCardClick(e) {
  const btn = e.target.closest(".toggle");
  const cmp = e.target.closest("input.cmp");
  if (btn) {
    const card = e.target.closest(".card");
    const full = $(".fulltext", card);
    const open = full.style.display !== "none";
    full.style.display = open ? "none" : "block";
    btn.textContent = open ? "å±•é–‹å…¨æ–‡" : "æ”¶åˆå…¨æ–‡";
  } else if (cmp) {
    const country = cmp.dataset.country;
    if (cmp.checked) {
      if (State.compareSet.size >= 3) {
        cmp.checked = false;
        alert("ä¸€æ¬¡æœ€å¤šæ¯”è¼ƒ 3 å€‹åœ‹å®¶");
        return;
      }
      State.compareSet.add(country);
    } else {
      State.compareSet.delete(country);
    }
    renderCompare();
  }
  // keep delegating
  $("#cardsWrap").addEventListener("click", onCardClick, { once: true });
}

/* ======================  Compare Drawer  ====================== */
function renderCompare() {
  const drawer = $("#compareDrawer");
  const list = $("#compareList");
  const arr = Array.from(State.compareSet);

  if (!arr.length) {
    drawer.classList.remove("open");
    list.innerHTML = `<div class="mini" style="color:#64748b;">å°šæœªé¸æ“‡åœ‹å®¶ã€‚å‹¾é¸å¡ç‰‡å³ä¸Šã€ŒåŠ å…¥æ¯”è¼ƒã€ã€‚</div>`;
    return;
  }
  drawer.classList.add("open");

  const items = arr.map((c) => {
    const d = State.data.find(x => x.Country === c);
    const bullets = deriveBullets(d).map(b => `â€¢ ${escapeHTML(b)}`).join("<br>");
    return `
      <div class="compare-item">
        <h4>${escapeHTML(d.Country)}</h4>
        <div class="mini"><strong>ç¨±å‘¼ï¼š</strong>${escapeHTML(d.TermsUsed || "â€”")}</div>
        <div class="mini" style="margin-top:4px">${bullets}</div>
      </div>
    `;
  }).join("");

  list.innerHTML = items;
}

function deriveBullets(d) {
  // Very simple rule-based summary
  const out = [];
  if (d.flags.HasPublicProvider) out.push("ç”±å…¬éƒ¨é–€/åœ°æ–¹æ”¿åºœæä¾›æˆ–ç®¡ç†");
  if (d.flags.HasNonProfitProvider) out.push("éç‡Ÿåˆ©/åˆä½œç¤¾ç‚ºä¸»è¦æä¾›è€…ä¹‹ä¸€");
  if (d.flags.HasBelowMarketRent) out.push("ç§Ÿé‡‘ä½æ–¼å¸‚åƒ¹æˆ–å—ç®¡åˆ¶");
  if (d.flags.HasIncomeTargeting) out.push("é‡å°ä½æ”¶å…¥/å¼±å‹¢æ—ç¾¤ï¼Œéœ€æ”¶å…¥å¯©æŸ¥");
  if (d.flags.HasSubsidyOrLoans) out.push("æä¾›è£œè²¼/è²¸æ¬¾/ç¨…å‹™å„ªæƒ ç­‰æ”¯æŒ");
  if (d.flags.LegalDefined) out.push("æœ‰æ³•å¾‹/æ³•è¦ä¸Šçš„æ˜ç¢ºå®šç¾©");
  if (!out.length) out.push(shortText(d.Definition, 120));
  return out.slice(0, 5);
}

async function copyCompare() {
  try {
    const arr = Array.from(State.compareSet);
    if (!arr.length) return;
    const blocks = arr.map(c => {
      const d = State.data.find(x => x.Country === c);
      const lines = [
        `åœ‹å®¶ï¼š${d.Country}`,
        `ç¨±å‘¼ï¼š${d.TermsUsed || "â€”"}`,
        `é‡é»ï¼š${deriveBullets(d).join("ï¼›")}`,
      ];
      return lines.join("\n");
    });
    await navigator.clipboard.writeText(blocks.join("\n\n"));
    alert("å·²è¤‡è£½æ¯”è¼ƒæ‘˜è¦ï¼");
  } catch {
    alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚");
  }
}

/* ======================  Helpers  ====================== */
function escapeHTML(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
